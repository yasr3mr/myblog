#___________________________________________________________________________________________________________________________
#_________________________________________Import Libraries_________________________________________________________________
from flask import Flask,render_template,redirect,request,session,url_for,flash
from forms import *
from db.Op import *
from passlib.hash import sha256_crypt
from functools import wraps
#___________________________________________________________________________________________________________________________
#___________________________________________________________________________________________________________________________




#_________________________________________________init app__________________________________________________________________
#___________________________________________________________________________________________________________________________
app=Flask(__name__)
#___________________________________________________________________________________________________________________________
#___________________________________________________________________________________________________________________________






#__________________________________________________________Home Page_________________________________________________________________
#___________________________________________________________________________________________________________________________
@app.route('/')
def index():
	return render_template('home.html')
#___________________________________________________________________________________________________________________________
#___________________________________________________________________________________________________________________________




#_____________________________________________________________register Page______________________________________________________________
#___________________________________________________________________________________________________________________________
@app.route("/register",methods=["GET","POST"])
def register():
	frm=User(request.form)
	if request.method=="POST" and frm.validate():
		name=frm.name.data
		username=frm.username.data
		email=frm.email.data
		password=frm.password.data
		registerUser(name,username,email,password)
		flash('You are registered and can log in!', 'success')
		return redirect(url_for("index"))
	return render_template("register.html",form=frm)
#___________________________________________________________________________________________________________________________
#___________________________________________________________________________________________________________________________




#_________________________________________________________________check is user logged in__________________________________________________________
#___________________________________________________________________________________________________________________________
def is_logged_in(f):
    @wraps(f)
    def wrap(*args, **kwargs):
        if 'logged_in' in session:
            return f(*args, **kwargs)
        else:
            flash('Unauthorized, please log in', 'danger')
            return redirect(url_for('login'))

    return wrap
#___________________________________________________________________________________________________________________________
#___________________________________________________________________________________________________________________________




#________________________________________________________________Logout ___________________________________________________________
#___________________________________________________________________________________________________________________________
@app.route('/logout')
@is_logged_in
def logout():
	session.clear()
	flash('You are now logged out!', 'success')
	return redirect(url_for("login"))
#___________________________________________________________________________________________________________________________
#___________________________________________________________________________________________________________________________




#_______________________________________________________________Login Page____________________________________________________________
#___________________________________________________________________________________________________________________________
@app.route('/login',methods=['GET','POST'])
def login():
	if request.method=="POST":
		username=request.form['username']
		password=request.form['password']
		query,data=checkUser(username)
		if query>0:
			_password=data['password']
			if sha256_crypt.verify(password,_password):
				if True:
					session['username']=username
					session['logged_in']=True
					flash('You are logged in', 'success')
					return redirect(url_for('dashboard'))
				else:
					error = 'User not found'
					return render_template('login.html',error=error)
		else:
			error = "Username not found"
			return render_template('login.html',error=error)
	return render_template('login.html')

#___________________________________________________________________________________________________________________________
#___________________________________________________________________________________________________________________________




#__________________________________________________________________Create Article Page _________________________________________________________
#___________________________________________________________________________________________________________________________
@app.route("/create",methods=["GET","POST"])
@is_logged_in
def create():
	frm=Blogs(request.form)
	if request.method=="POST" and frm.validate():
		title=frm.title.data
		content=frm.content.data
		user=session['username']
		createBlog(title,content,user)
		flash('Article has been published successfully!', 'success')
		return redirect(url_for("dashboard"))
	return render_template("add_article.html",form=frm)
#___________________________________________________________________________________________________________________________
#___________________________________________________________________________________________________________________________




#_________________________________________________________________delete Article__________________________________________________________
#___________________________________________________________________________________________________________________________
@app.route("/delete/<string:id>",methods=["GET","POST"])
@is_logged_in
def delete(id):
	deleteBlog(id)
	flash('Article has been DELETED!', 'success')
	return redirect(url_for("dashboard"))
#___________________________________________________________________________________________________________________________




#__________________________________________________________________show all Article_________________________________________________________
#___________________________________________________________________________________________________________________________
@app.route("/articles")
def showallblogs():
	query,data=getAllBlogs()
	if query>0:
		return render_template("articles.html",data=data)
	else:
		msg = "No articles found"
		return render_template("articles.html",msg=msg)
#___________________________________________________________________________________________________________________________
#___________________________________________________________________________________________________________________________




#_____________________________________________________________________show Article detail______________________________________________________
#___________________________________________________________________________________________________________________________	
@app.route("/article/<string:id>")
def showoneblogs(id):
	query,data=getOneBlog(id)
	if query>0:
		return render_template("article.html",data=data)
	else:
		return render_template("article.html")
#___________________________________________________________________________________________________________________________
#___________________________________________________________________________________________________________________________




#____________________________________________________________________edit Article_______________________________________________________
#___________________________________________________________________________________________________________________________
@app.route("/edit/<string:id>",methods=["GET","POST"])
@is_logged_in
def update(id):
	frm=Blogs(request.form)
	query,data=getOneBlog(id)
	frm.title.data=data["title"]
	frm.content.data=data["content"]
	if request.method=="POST" and frm.validate():
		title=request.form["title"]
		content=request.form["content"]
		user=session['username']
		updateBlog(id,title,content,user)
		flash('Article has been UPDATED successfully!', 'success')
		return redirect(url_for("dashboard"))
	return render_template("edit_article.html",form=frm)
#___________________________________________________________________________________________________________________________
#___________________________________________________________________________________________________________________________




#_______________________________________________________________about page____________________________________________________________
#___________________________________________________________________________________________________________________________

@app.route("/about")
def about():
	return render_template("about.html")
#___________________________________________________________________________________________________________________________
#___________________________________________________________________________________________________________________________





#________________________________________________________________dashboard page___________________________________________________________
@app.route('/dashboard')
@is_logged_in
def dashboard():
	user=session["username"]
	query,data=getAllBlogsForUser(user)
	if query>0:
		return render_template("dashboard.html",data=data)
	else:
		msg = "No articles found"
		return render_template("dashboard.html",msg=msg)
#___________________________________________________________________________________________________________________________




#_______________________________________________________________main____________________________________________________________

if __name__=="__main__":
	app.secret_key = '@%^&(*9867ahsh)'
	app.run(debug=True)

#___________________________________________________________________________________________________________________________
